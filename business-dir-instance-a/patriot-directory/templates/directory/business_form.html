{% extends "base.html" %}
{% load static %}
{% load form_extras %}.
{% block title %}
  {% if object %}Edit {{ object.name }} · Patriot{% else %}Create Business · Patriot{% endif %}
{% endblock %}

{% block extra_css %}
<style>
  .form-help { font-size: .9rem; opacity:.8 }
  .required-asterisk::after { content:" *"; color: var(--bs-danger); }
</style>
{% endblock %}

{% block content %}

<div class="row justify-content-center">
  <div class="col-12 col-lg-10 col-xxl-8">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h1 class="h3 mb-1">
          {% if object %}Edit Business{% else %}Create Business{% endif %}
        </h1>
        <p class="text-body-secondary mb-0">
          Add clear details so customers can discover you more easily.
        </p>
      </div>

      <div>
        <a href="{% url 'directory:list' %}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left-long me-2"></i>Back to list
        </a>
      </div>
    </div>

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">

          <div class="row g-4">
            <!-- Name -->
            <div class="col-12 col-md-7">
              <label for="{{ form.name.id_for_label }}" class="form-label required-asterisk">Name</label>
              {{ form.name|add_class:"form-control" }}
              {% if form.name.errors %}
                <div class="invalid-feedback d-block">{{ form.name.errors|striptags }}</div>
              {% else %}
                <div class="form-help">Your public business name.</div>
              {% endif %}
            </div>

            <!-- Category -->
            <div class="col-12 col-md-5">
              <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
              {{ form.category|add_class:"form-control" }}
              {% if form.category.errors %}
                <div class="invalid-feedback d-block">{{ form.category.errors|striptags }}</div>
              {% else %}
                <div class="form-help">e.g., “Cafe”, “Plumbing”, “Pet Care”.</div>
              {% endif %}
            </div>

            <!-- Description -->
            <div class="col-12">
              <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
              {{ form.description|add_class:"form-control" }}
              {% if form.description.errors %}
                <div class="invalid-feedback d-block">{{ form.description.errors|striptags }}</div>
              {% else %}
                <div class="form-help">What you do, services, hours, specialties (a few sentences).</div>
              {% endif %}
            </div>

            <!-- Address -->
            <div class="col-12">
              <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
              {{ form.address|add_class:"form-control" }}
              {% if form.address.errors %}
                <div class="invalid-feedback d-block">{{ form.address.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- Phone -->
            <div class="col-12 col-md-6">
              <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
              {{ form.phone|add_class:"form-control" }}
              {% if form.phone.errors %}
                <div class="invalid-feedback d-block">{{ form.phone.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- Website -->
            <div class="col-12 col-md-6">
              <label for="{{ form.website.id_for_label }}" class="form-label">Website</label>
              {{ form.website|add_class:"form-control" }}
              {% if form.website.errors %}
                <div class="invalid-feedback d-block">{{ form.website.errors|striptags }}</div>
              {% else %}
                <div class="form-help">Include https:// for best results.</div>
              {% endif %}
            </div>

            <!-- Slug (Create only) -->
            {% if form.slug %}
            <div class="col-12">
              <label for="{{ form.slug.id_for_label }}" class="form-label required-asterisk">Slug</label>
              <div class="input-group">
                <span class="input-group-text d-none d-md-inline">/b/</span>
                {{ form.slug|add_class:"form-control" }}
              </div>
              {% if form.slug.errors %}
                <div class="invalid-feedback d-block">{{ form.slug.errors|striptags }}</div>
              {% else %}
                <div class="form-help">
                  Used in the URL. Only letters, numbers, and hyphens. Auto-filled from the name; you can edit it.
                </div>
              {% endif %}
            </div>
            {% endif %}
          </div>

        </div>

        <div class="card-footer d-flex justify-content-between align-items-center p-3">
          <a href="{% url 'directory:list' %}" class="btn btn-outline-secondary">
            Cancel
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-floppy-disk me-2"></i>Save
          </button>
        </div>
      </div>
    </form>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  (function () {
    // Basic helper to add bootstrap .is-invalid when server returns errors (progressive enhancement)
    document.querySelectorAll('.invalid-feedback').forEach(function (fb) {
      var control = fb.previousElementSibling;
      if (control && control.classList && control.classList.contains('form-control')) {
        control.classList.add('is-invalid');
      }
    });

    // Auto-generate slug from name (only when slug field exists—Create view)
    var nameInput = document.getElementById("{{ form.name.id_for_label }}");
    var slugInput = document.getElementById("{{ form.slug.id_for_label }}");
    if (nameInput && slugInput) {
      var touched = false;

      slugInput.addEventListener('input', function(){ touched = true; });

      nameInput.addEventListener('input', function () {
        if (touched) return; // don't overwrite manual edits
        var value = (nameInput.value || "")
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "")
          .substring(0, 220);
        slugInput.value = value;
      });
    }
  })();
</script>
{% endblock %}
