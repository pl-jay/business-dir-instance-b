{% extends "base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Review{% else %}Create Review{% endif %} · Patriot{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-xl-9 col-xxl-7">

    <div class="d-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0">
        {% if form.instance.pk %}Edit Review{% else %}Create Review{% endif %}
      </h1>
      {# When the reviews list has been removed, redirect back to the referring page or to a provided ?next parameter. #}
      <a class="btn btn-outline-secondary btn-sm"
         href="{{ request.GET.next|default:request.META.HTTP_REFERER|default:'/' }}">
        <i class="fa-solid fa-arrow-left-long me-1"></i> Back
      </a>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <form id="review-form" method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}
          {# Persist the next/return URL through the form so the view can redirect appropriately #}
          <input type="hidden" name="next" value="{{ request.GET.next|default:request.META.HTTP_REFERER }}" />
          {{ form.non_field_errors }}

          <div class="mb-3">
            <label class="form-label" for="{{ form.rating.id_for_label }}">Overall rating (1–5)</label>
            {{ form.rating }}
            <div class="form-text">You can select half stars by choosing decimals like 3.5.</div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="{{ form.rating_service.id_for_label }}">Service</label>
              {{ form.rating_service }}
            </div>
            <div class="col-md-6">
              <label class="form-label" for="{{ form.rating_value.id_for_label }}">Value</label>
              {{ form.rating_value }}
            </div>
            <div class="col-md-6">
              <label class="form-label" for="{{ form.rating_quality.id_for_label }}">Quality</label>
              {{ form.rating_quality }}
            </div>
            <div class="col-md-6">
              <label class="form-label" for="{{ form.rating_cleanliness.id_for_label }}">Cleanliness</label>
              {{ form.rating_cleanliness }}
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label class="form-label" for="{{ form.comment.id_for_label }}">Comment</label>
            {{ form.comment }}
            <div class="form-text">Be specific and respectful. Minimum 20 characters. No personal info.</div>
            <div class="form-text"><span id="char-count">0</span> characters</div>
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.attachments.id_for_label }}">Attachments</label>
            {{ form.attachments }}
            <div class="form-text">You can select multiple files.</div>
          </div>

          <div class="form-check mb-3">
            {{ form.is_anonymous }}
            <label class="form-check-label" for="{{ form.is_anonymous.id_for_label }}">Post anonymously</label>
          </div>
          <div class="mb-3">
            <label class="form-label" for="{{ form.display_name.id_for_label }}">Display name</label>
            {{ form.display_name }}
            <div class="form-text">Optional. If anonymous, this will be shown instead of your username.</div>
          </div>

          <div class="d-flex justify-content-between">
            <a class="btn btn-outline-secondary"
               href="{{ request.GET.next|default:request.META.HTTP_REFERER|default:'/' }}">
              Cancel
            </a>
            <button class="btn btn-primary">
              <i class="fa-regular fa-floppy-disk me-1"></i> Save
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const textarea = document.getElementById('{{ form.comment.id_for_label }}');
    const counter = document.getElementById('char-count');
    if (textarea && counter) {
      const updateCount = () => {
        counter.textContent = textarea.value.length;
      };
      textarea.addEventListener('input', updateCount);
      updateCount();
    }
  });

document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('review-form');
  const textarea = document.getElementById('id_comment'); // adjust if your id differs
  const MIN = 20; // required minimum

  // Optional: live counter color change
  const counter = document.getElementById('char-count'); // if you have one
  const updateCounter = () => {
    if (!counter) return;
    const len = (textarea.value || '').trim().length;
    counter.textContent = len;
    counter.classList.toggle('text-danger', len < MIN);
  };

  form.addEventListener('submit', function (e) {
    const len = (textarea.value || '').trim().length;
    if (len < MIN) {
      e.preventDefault();
      alert(`Please write at least ${MIN} characters. You're at ${len}.`);
      textarea.focus();
    }
  });

  if (textarea) {
    textarea.addEventListener('input', updateCounter);
    updateCounter();
  }
});
</script>
{% endblock %}